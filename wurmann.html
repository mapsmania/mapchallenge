<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Bars vs Baskets</title>
  <link href="https://unpkg.com/maplibre-gl@3.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.4.0/dist/maplibre-gl.js"></script>
  <style>
    body { margin: 0; padding: 0; font-family: system-ui, sans-serif; }
    #map { width: 100%; height: 100vh; }

    /* Legend styling */
    .legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(255,255,255,0.92);
      padding: 12px 16px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      font-size: 14px;
      min-width: 180px;
    }
    .legend-title {
      font-weight: 600;
      margin-bottom: 6px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin: 4px 0;
    }
    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .blue { background: #007AFF; }
    .red { background: #FF3B30; }
    .legend-note {
      font-size: 12px;
      color: #555;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="legend" class="legend">
    <div class="legend-title">Last Click Summary</div>
    <div class="legend-item"><span class="legend-color blue"></span>Bars & Pubs: <span id="bar-count">–</span></div>
    <div class="legend-item"><span class="legend-color red"></span>Supermarkets & Convenience: <span id="super-count">–</span></div>
    <div class="legend-note">Circle size ∝ number of places</div>
  </div>

  <script>
    const map = new maplibregl.Map({
  container: 'map',
  style: 'https://tiles.openfreemap.org/styles/positron',
  center: [-0.1276, 51.5072],
  zoom: 12,
  attributionControl: false // we’ll add a custom one
});

      const attribution = new maplibregl.AttributionControl({
  compact: true
});

map.addControl(attribution, 'bottom-right'); // position it

// Append your 'About' link to the attribution container
map.on('load', () => {
  const container = map.getContainer();
  const attrEl = container.querySelector('.maplibregl-ctrl-attrib');
  if (attrEl) {
    const aboutLink = document.createElement('a');
    aboutLink.href = 'https://googlemapsmania.blogspot.com/';
    aboutLink.target = '_blank';
    aboutLink.style.marginLeft = '8px';
    aboutLink.textContent = 'About';
    attrEl.appendChild(aboutLink);
  }
});



    // Shared GeoJSON source for all points
    map.on('load', () => {
      map.addSource('click-points', {
        type: 'geojson',
        data: { type: 'FeatureCollection', features: [] }
      });
    });

    map.on('click', async (e) => {
      const lat = e.lngLat.lat;
      const lon = e.lngLat.lng;
      const delta = 1 / 69; // ~1 mile in degrees

      const south = lat - delta / 2;
      const north = lat + delta / 2;
      const west = lon - delta / 2;
      const east = lon + delta / 2;

      // Overpass query for bars/pubs and supermarkets/convenience
      const query = `
        [out:json];
        (
          node["amenity"~"bar|pub"](${south},${west},${north},${east});
          node["shop"~"supermarket|convenience"](${south},${west},${north},${east});
        );
        out;
      `;
      const url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);
      const response = await fetch(url);
      const data = await response.json();

      let bars = 0, supermarkets = 0;
      for (const el of data.elements) {
        if (el.tags?.amenity === 'bar' || el.tags?.amenity === 'pub') bars++;
        if (el.tags?.shop === 'supermarket' || el.tags?.shop === 'convenience') supermarkets++;
      }

      // Update dynamic legend
      document.getElementById('bar-count').textContent = bars;
      document.getElementById('super-count').textContent = supermarkets;

      // Scale function for circle size
      const scale = v => Math.max(10, Math.min(80, v * 3));

      const barRadius = scale(bars);
      const superRadius = scale(supermarkets);

      // Generate unique click ID for filtering
      const clickId = Date.now();

      // Add features to shared source
      const source = map.getSource('click-points');
      const features = [
        { type: 'Feature', geometry: { type: 'Point', coordinates: [lon, lat] }, properties: { type: 'bars', barRadius, id: clickId } },
        { type: 'Feature', geometry: { type: 'Point', coordinates: [lon, lat] }, properties: { type: 'supermarkets', superRadius, id: clickId } }
      ];
      const existing = source._data || { type: 'FeatureCollection', features: [] };
      existing.features.push(...features);
      source.setData(existing);

      // Determine which circle is larger
const largerFirst = bars > supermarkets ? ['bars', 'super'] : ['super', 'bars'];

// Add the larger circle first
map.addLayer({
  id: `${largerFirst[0]}-${clickId}`,
  type: 'circle',
  source: 'click-points',
  filter: ['all', ['==', ['get', 'id'], clickId], ['==', ['get', 'type'], largerFirst[0] === 'bars' ? 'bars' : 'supermarkets']],
  paint: {
    'circle-color': largerFirst[0] === 'bars' ? '#007AFF' : '#FF3B30',
    'circle-opacity': 0.9,
    'circle-radius': ['get', largerFirst[0] === 'bars' ? 'barRadius' : 'superRadius']
  }
});

// Add the smaller circle second
map.addLayer({
  id: `${largerFirst[1]}-${clickId}`,
  type: 'circle',
  source: 'click-points',
  filter: ['all', ['==', ['get', 'id'], clickId], ['==', ['get', 'type'], largerFirst[1] === 'bars' ? 'bars' : 'supermarkets']],
  paint: {
    'circle-color': largerFirst[1] === 'bars' ? '#007AFF' : '#FF3B30',
    'circle-opacity': 0.9,
    'circle-radius': ['get', largerFirst[1] === 'bars' ? 'barRadius' : 'superRadius']
  }
});

    });
  </script>
</body>
</html>

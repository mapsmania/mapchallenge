<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Minimal London</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"
    rel="stylesheet"
  />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <style>
    body, html { margin: 0; padding: 0; height: 100%; background: #000; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
   #london-label {
  position: absolute;
  bottom: 20px;
  right: 20px;
  color: #fff;
  font-family: sans-serif;
  font-weight: bold;
  font-size: 15vw;       /* scales with viewport width */
  line-height: 1;
  pointer-events: none;
  user-select: none;
}
  .live-plane {
  width: 6px;           /* small dot */
  height: 6px;
  background-color: #fff; /* white dot */
  border-radius: 50%;     /* make it circular */
  box-shadow: 0 0 2px #fff;
  transition: transform 1s linear; /* smooth movement */
}

  </style>
</head>
<body>
  <div id="map"></div>
  <div id="london-label">LDN</div>

  <script>
    // Create the map with no basemap or style layers
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        sources: {},
        layers: [],
        glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf'
      },
      center: [-0.1, 51.5],  // approximate London center
      zoom: 11
    });

   
    map.on('load', () => {
      // Add GeoJSON source
      map.addSource('london', {
        type: 'geojson',
        data: 'data/miles.geojson'
      });

   // --- River Thames ---
map.addLayer({
  id: 'thames',
  type: 'line',
  source: 'london',
  paint: {
    'line-color': '#0077cc',
    'line-width': 14
  },
  filter: ['==', ['get', 'name'], 'River Thames']  // river features only
});

// --- Bridges ---
map.addLayer({
  id: 'bridges',
  type: 'line',
  source: 'london',
  paint: {
    'line-color': '#fff',
    'line-width': 1.5
  },
  filter: ['==', ['get', 'name'], 'bridge']  // bridge features only
});



      // Adjust view to fit all features
      const bounds = new maplibregl.LngLatBounds();
      fetch('data/miles.geojson')
        .then(resp => resp.json())
        .then(data => {
          data.features.forEach(f => {
            const coords = f.geometry.coordinates.flat(Infinity);
            for (let i = 0; i < coords.length; i += 2) {
              bounds.extend([coords[i], coords[i + 1]]);
            }
          });
          map.fitBounds(bounds, { padding: 40 });
        });
    });
// add realtime planes
    let livePlanes = {}; // { icao24: { marker, lastUpdate } }

async function fetchLivePlanes() {
  const bounds = map.getBounds();
  const lamin = bounds.getSouth();
  const lomin = bounds.getWest();
  const lamax = bounds.getNorth();
  const lomax = bounds.getEast();

  const url = `https://opensky-network.org/api/states/all?lamin=${lamin}&lomin=${lomin}&lamax=${lamax}&lomax=${lomax}`;

  try {
    const res = await fetch(url);
    const data = await res.json();
    updateLivePlanes(data.states || []);
  } catch (err) {
    console.error("Error fetching plane data", err);
  }
}

function updateLivePlanes(states) {
  const seen = new Set();

  states.forEach(plane => {
    const icao24 = plane[0];
    const callsign = plane[1];
    const lon = plane[5];
    const lat = plane[6];
    if (!lat || !lon) return;

    seen.add(icao24);

    if (livePlanes[icao24]) {
      // Update existing marker position smoothly
      livePlanes[icao24].marker.setLngLat([lon, lat]);
      livePlanes[icao24].lastUpdate = Date.now();
    } else {
      // Create new marker as a small white dot
      const el = document.createElement("div");
      el.className = "live-plane";
      el.title = callsign || "Plane";

      const marker = new maplibregl.Marker({ element: el })
        .setLngLat([lon, lat])
        .addTo(map);

      livePlanes[icao24] = { marker, lastUpdate: Date.now() };
    }
  });

  // Remove planes no longer in view
  for (const id in livePlanes) {
    if (!seen.has(id)) {
      livePlanes[id].marker.remove();
      delete livePlanes[id];
    }
  }
}

// Start fetching every 10 seconds
map.on("load", () => {
  fetchLivePlanes();
  setInterval(fetchLivePlanes, 10000);
});

  </script>
</body>
</html>

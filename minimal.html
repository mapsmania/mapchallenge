<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Minimal Thames Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"
    rel="stylesheet"
  />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <style>
    body, html { margin: 0; padding: 0; height: 100%; background: #fff; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        sources: {},
        layers: [],
        glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf'
      },
      center: [-0.1, 51.5],
      zoom: 11
    });

    map.on('load', () => {
      // Load your GeoJSON with river, bridges, and distance points
      fetch('data/miles.geojson')
        .then(resp => resp.json())
        .then(data => {

          // Add main GeoJSON source
          map.addSource('london', {
            type: 'geojson',
            data: data
          });

          // --- River Thames ---
          map.addLayer({
            id: 'thames',
            type: 'line',
            source: 'london',
            paint: {
              'line-color': '#0077cc',
              'line-width': 4
            },
            filter: ['==', ['get', 'name'], 'River Thames']
          });

          // --- Bridges ---
          map.addLayer({
            id: 'bridges',
            type: 'line',
            source: 'london',
            paint: {
              'line-color': '#000000',
              'line-width': 1.5
            },
            filter: ['==', ['get', 'name'], 'bridge']
          });

          // --- Create line segments for distance labels ---
          const distancePoints = data.features.filter(f => f.geometry.type === 'Point' && f.properties.miles != null);
          const distanceLines = [];
          for (let i = 0; i < distancePoints.length - 1; i++) {
            const start = distancePoints[i].geometry.coordinates;
            const end = distancePoints[i + 1].geometry.coordinates;
            const miles = distancePoints[i + 1].properties.miles; // label at second point
            distanceLines.push({
              type: "Feature",
              properties: { miles: miles + ' mi' },
              geometry: {
                type: "LineString",
                coordinates: [start, end]
              }
            });
          }

          // Add new source for distance label lines
          map.addSource('distance-lines', {
            type: 'geojson',
            data: { type: "FeatureCollection", features: distanceLines }
          });

          // --- Distance labels following the line ---
          map.addLayer({
            id: 'distance-labels',
            type: 'symbol',
            source: 'distance-lines',
            layout: {
              'symbol-placement': 'line',
              'text-field': ['get', 'miles'],
              'text-size': 11,
              'text-anchor': 'center'
            },
            paint: {
              'text-color': '#000000',
              'text-halo-color': '#ffffff',
              'text-halo-width': 1
            }
          });

          // --- Fit map to all features ---
          const bounds = new maplibregl.LngLatBounds();
          data.features.forEach(f => {
            const coords = f.geometry.coordinates.flat(Infinity);
            for (let i = 0; i < coords.length; i += 2) {
              bounds.extend([coords[i], coords[i + 1]]);
            }
          });
          map.fitBounds(bounds, { padding: 40 });
        });
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Yamanote Line with Melodies</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- MapLibre GL CSS -->
<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@700&display=swap" rel="stylesheet">

<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<style>
html, body { margin:0; padding:0; height:100%; }
#map { width:100%; height:100vh; }
#splash { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); color:#fff;
display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:10; text-align:center; padding:20px; }
#splash h1 { font-size:2em; margin-bottom:1em; }
#splash p { max-width:500px; line-height:1.5em; margin-bottom:2em; }
#startButton { background:#0066ff; color:#fff; border:none; border-radius:4px; padding:12px 20px; font-size:1.1em; cursor:pointer; }
#muteButton { position:absolute; top:10px; right:10px; z-index:5; background: rgba(0,0,0,0.6); color:#fff; border:none; border-radius:4px; padding:8px 12px; cursor:pointer; }
#nowPlaying { position:absolute; left:50%; bottom:28px; transform:translateX(-50%) translateY(8px);
background: rgba(0,0,0,0.62); color:#fff; padding:10px 16px; border-radius:10px; font-family:'Noto Sans', sans-serif; font-size:14px; z-index:8; opacity:0;
pointer-events:none; transition: opacity 420ms ease, transform 420ms ease; backdrop-filter:blur(4px); box-shadow:0 6px 18px rgba(0,0,0,0.35);}
#nowPlaying.visible { opacity:1; transform:translateX(-50%) translateY(0); }
#map-links { position:absolute; top:10px; left:10px; z-index:15; background:rgba(255,255,255,0.8); padding:6px 12px; border-radius:6px; font-family:sans-serif; font-size:14px; }
#map-links a { color:#0066ff; text-decoration:none; font-weight:bold; margin:0 4px; }
#map-links a:hover { text-decoration:underline; }
</style>
</head>
<body>

<div id="splash">
<h1>Tokyo Departure Melodies</h1>
<p>The JR Yamanote Line in Tokyo is famous for its unique <strong>departure melodies</strong>.
Each station has its own tune that plays before a train departs.
This interactive map animates a train and plays each stationâ€™s melody.</p>
<button id="startButton">Start Journey</button>
</div>

<div id="map"></div>
<button id="muteButton">ðŸ”Š Mute</button>
<div id="nowPlaying" aria-live="polite">Now Playing: â€”</div>
<div id="map-links">
<a href="https://yamanot.es/" target="_blank">Inspired by Yamanotes</a> |
<a href="https://googlemapsmania.blogspot.com/" target="_blank">About</a>
</div>

<script>
const map = new maplibregl.Map({
  container: 'map',
  style: 'https://mapsmania.github.io/mapchallenge/data/tokyo.json',
  center: [139.7325, 35.6925], // precomputed center of Yamanote loop
  zoom: 12.2,
  pitch: 0,
  bearing: 300
});

    map.addControl(new maplibregl.AttributionControl({
  compact: true,
  customAttribution: '<a href="https://experience-japan.info/en" target="_blank">Nippon Design Center, Inc.</a>'
}));


let isMuted = false;
const AUDIO_BASE = 'https://raw.githubusercontent.com/morgansleeper/Yamanotes/main/audio/';

const stations = [
  {name:'Tokyo', coord:[139.7671,35.6812], slug:'sh3'},
  {name:'Kanda', coord:[139.7706,35.6960], slug:'seseragi'},
  {name:'Akihabara', coord:[139.7754,35.7008], slug:'ogawav1'},
  {name:'Okachimachi', coord:[139.7770,35.7074], slug:'harutrem'},
  {name:'Ueno', coord:[139.7770,35.7138], slug:'bellb'},
  {name:'Uguisudani', coord:[139.7822,35.7278], slug:'harutrem'},
  {name:'Nippori', coord:[139.7780,35.7325], slug:'harutrem'},
  {name:'Nishi-Nippori', coord:[139.7660,35.7546], slug:'harutrem'},
  {name:'Tabata', coord:[139.7626,35.7434], slug:'harutrem'},
  {name:'Komagome', coord:[139.7520,35.7366], slug:'sakurab'},
  {name:'Sugamo', coord:[139.7476,35.7312], slug:'haru'},
  {name:'Otsuka', coord:[139.7360,35.7335], slug:'haru'},
  {name:'Ikebukuro', coord:[139.7283,35.7203], slug:'melody'},
  {name:'Mejiro', coord:[139.7191,35.7126], slug:'haru'},
  {name:'Takadanobaba', coord:[139.7061,35.7009], slug:'astrob'},
  {name:'Shin-Okubo', coord:[139.7004,35.7013], slug:'bellb'},
  {name:'Shinjuku', coord:[139.7020,35.6900], slug:'aratana'},
  {name:'Yoyogi', coord:[139.7021,35.6730], slug:'haru'},
  {name:'Harajuku', coord:[139.7100,35.6698], slug:'harajukua'},
  {name:'Shibuya', coord:[139.7013,35.6580], slug:'hananohorokobi'},
  {name:'Ebisu', coord:[139.6899,35.6412], slug:'thirdman'},
  {name:'Meguro', coord:[139.6984,35.6340], slug:'watercrown'},
  {name:'Gotanda', coord:[139.7032,35.6285], slug:'sh23'},
  {name:'Osaki', coord:[139.7148,35.6197], slug:'uminoeki'},
  {name:'Shinagawa', coord:[139.7220,35.6457], slug:'seseragi'},
  {name:'TakanawaGW', coord:[139.7383,35.6365], slug:'sweetcall'},
  {name:'Tamachi', coord:[139.7290,35.6554], slug:'seseragi'},
  {name:'Hamamatsucho', coord:[139.7400,35.6580], slug:'seseragi'},
  {name:'Shimbashi', coord:[139.7616,35.6721], slug:'gotadelvient'},
  {name:'Yurakucho', coord:[139.7640,35.6751], slug:'sh21'},
  {name:'Tokyo(end)', coord:[139.7671,35.6812], slug:'sh3'}
];

const lineCoords = stations.map(s => s.coord);

// Now Playing overlay
const nowPlayingEl = document.getElementById('nowPlaying');
let nowPlayingTimeout = null;
function showNowPlaying(text, duration = 3500){
  if(nowPlayingTimeout) clearTimeout(nowPlayingTimeout);
  nowPlayingEl.textContent='Now Playing: '+text;
  nowPlayingEl.classList.add('visible');
  nowPlayingTimeout=setTimeout(()=>{nowPlayingEl.classList.remove('visible');}, duration);
}

map.on('load', () => {

                map.loadImage(
  'https://mapsmania.github.io/mapchallenge/data/P_meiji-jingu.png',
  (error, image) => {
    if (error) throw error;

    if (!map.hasImage('meijiIcon')) map.addImage('meijiIcon', image);

   
    map.addLayer({
      id: 'meiji',
      type: 'symbol',
      source: {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: [
            {
              type: 'Feature',
              geometry: {
                type: 'Point',
                coordinates: [139.6997529484473, 35.67635679098964]
              },
              properties: { name: 'Meiji Shrine' }
            }
          ]
        }
      },
      layout: {
        'icon-image': 'meijiIcon',
        'icon-size': 0.02,
        'icon-allow-overlap': true,
        'text-field': ['get', 'name'],
        'text-size': 12,
        'text-offset': [0, 1.2],
        'text-anchor': 'top',
        'text-font': ['Noto Sans Bold']
      },
      paint: {
        'text-color': '#000000',
        'text-halo-color': '#ffffff',
        'text-halo-width': 1
      }
    });
  }
);





             map.loadImage(
  'https://mapsmania.github.io/mapchallenge/data/P_imperial-palace.png',
  (error, image) => {
    if (error) throw error;

    if (!map.hasImage('imperialIcon')) map.addImage('imperialIcon', image);

   
    map.addLayer({
      id: 'imperialPalace',
      type: 'symbol',
      source: {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: [
            {
              type: 'Feature',
              geometry: {
                type: 'Point',
                coordinates: [139.75341005441024, 35.685239515692636]
              },
              properties: { name: 'Imperial Palace' }
            }
          ]
        }
      },
      layout: {
        'icon-image': 'imperialIcon',
        'icon-size': 0.02,
        'icon-allow-overlap': true,
        'text-field': ['get', 'name'],
        'text-size': 12,
        'text-offset': [0, 1.2],
        'text-anchor': 'top',
        'text-font': ['Noto Sans Bold']
      },
      paint: {
        'text-color': '#000000',
        'text-halo-color': '#ffffff',
        'text-halo-width': 1
      }
    });
  }
);




         map.loadImage(
  'https://mapsmania.github.io/mapchallenge/data/P_tokyo-skytree.png',
  (error, image) => {
    if (error) throw error;

    if (!map.hasImage('skytreeIcon')) map.addImage('skytreeIcon', image);

   
    map.addLayer({
      id: 'skytree',
      type: 'symbol',
      source: {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: [
            {
              type: 'Feature',
              geometry: {
                type: 'Point',
                coordinates: [139.81076684543913, 35.70991978422469]
              },
              properties: { name: 'Tokyo Skytree' }
            }
          ]
        }
      },
      layout: {
        'icon-image': 'skytreeIcon',
        'icon-size': 0.02,
        'icon-allow-overlap': true,
        'text-field': ['get', 'name'],
        'text-size': 12,
        'text-offset': [0, 1.2],
        'text-anchor': 'top',
        'text-font': ['Noto Sans Bold']
      },
      paint: {
        'text-color': '#000000',
        'text-halo-color': '#ffffff',
        'text-halo-width': 1
      }
    });
  }
);



     map.loadImage(
  'https://mapsmania.github.io/mapchallenge/data/P_budokan.png',
  (error, image) => {
    if (error) throw error;

    if (!map.hasImage('budokanIcon')) map.addImage('budokanIcon', image);

   
    map.addLayer({
      id: 'budokan',
      type: 'symbol',
      source: {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: [
            {
              type: 'Feature',
              geometry: {
                type: 'Point',
                coordinates: [ 139.7500118411466, 35.693371649972576]
              },
              properties: { name: 'Nippon BudÅkan' }
            }
          ]
        }
      },
      layout: {
        'icon-image': 'budokanIcon',
        'icon-size': 0.02,
        'icon-allow-overlap': true,
        'text-field': ['get', 'name'],
        'text-size': 12,
        'text-offset': [0, 1.2],
        'text-anchor': 'top',
        'text-font': ['Noto Sans Bold']
      },
      paint: {
        'text-color': '#000000',
        'text-halo-color': '#ffffff',
        'text-halo-width': 1
      }
    });
  }
);


    map.loadImage(
  'https://mapsmania.github.io/mapchallenge/data/P_tokyo-dome.png',
  (error, image) => {
    if (error) throw error;

    if (!map.hasImage('tokyoDomeIcon')) map.addImage('tokyoDomeIcon', image);

   
    map.addLayer({
      id: 'tokyo-dome',
      type: 'symbol',
      source: {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: [
            {
              type: 'Feature',
              geometry: {
                type: 'Point',
                coordinates: [ 139.75201717784418, 35.70558000001608]
              },
              properties: { name: 'Tokyo Dome' }
            }
          ]
        }
      },
      layout: {
        'icon-image': 'tokyoDomeIcon',
        'icon-size': 0.02,
        'icon-allow-overlap': true,
        'text-field': ['get', 'name'],
        'text-size': 12,
        'text-offset': [0, 1.2],
        'text-anchor': 'top',
        'text-font': ['Noto Sans Bold']
      },
      paint: {
        'text-color': '#000000',
        'text-halo-color': '#ffffff',
        'text-halo-width': 1
      }
    });
  }
);

  // Tokyo Tower marker
map.loadImage(
  'https://mapsmania.github.io/mapchallenge/data/P_tokyo-tower.png',
  (error, image) => {
    if (error) throw error;

    if (!map.hasImage('tokyoTowerIcon')) map.addImage('tokyoTowerIcon', image);

    // Add Tokyo Tower as a symbol layer
    map.addLayer({
      id: 'tokyo-tower',
      type: 'symbol',
      source: {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: [
            {
              type: 'Feature',
              geometry: {
                type: 'Point',
                coordinates: [139.7454329, 35.6585805]
              },
              properties: { name: 'Tokyo Tower' }
            }
          ]
        }
      },
      layout: {
        'icon-image': 'tokyoTowerIcon',
        'icon-size': 0.02,
        'icon-allow-overlap': true,
        'text-field': ['get', 'name'],
        'text-size': 12,
        'text-offset': [0, 1.2],
        'text-anchor': 'top',
        'text-font': ['Noto Sans Bold']
      },
      paint: {
        'text-color': '#000000',
        'text-halo-color': '#ffffff',
        'text-halo-width': 1
      }
    });
  }
);

    map.loadImage(

    'https://mapsmania.github.io/mapchallenge/data/P_national-stadium.png',
  (error, image) => {
    if (error) throw error;

    if (!map.hasImage('nationalStadiumIcon')) map.addImage('nationalStadiumIcon', image);


    map.addLayer({
      id: 'mational-stadium',
      type: 'symbol',
      source: {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: [
            {
              type: 'Feature',
              geometry: {
                type: 'Point',
                coordinates: [139.7146200888805,35.677780661858876]
              },
              properties: { name: 'National Stadium' }
            }
          ]
        }
      },
      layout: {
        'icon-image': 'nationalStadiumIcon',
        'icon-size': 0.02,
        'icon-allow-overlap': true,
        'text-field': ['get', 'name'],
        'text-size': 12,
        'text-offset': [0, 1.2],
        'text-anchor': 'top',
        'text-font': ['Noto Sans Bold']
      },
      paint: {
        'text-color': '#000000',
        'text-halo-color': '#ffffff',
        'text-halo-width': 1
      }
    });
  }
);
  
  // Draw line
  map.addSource('yamanote', {type:'geojson', data:{type:'Feature', geometry:{type:'LineString', coordinates:lineCoords}}});
  map.addLayer({id:'yamanote-line', type:'line', source:'yamanote', paint:{'line-color':'#ff4f00','line-width':4}});

  // Stations
  map.addSource('stations',{type:'geojson', data:{
    type:'FeatureCollection',
    features:stations.filter(s=>s.name!=='Tokyo(end)').map(s=>({type:'Feature', geometry:{type:'Point', coordinates:s.coord}, properties:{name:s.name}}))
  }});

  map.loadImage('https://mapsmania.github.io/mapchallenge/data/T_train.png',(err,image)=>{
    if(err) throw err;
    if(!map.hasImage('stationIcon')) map.addImage('stationIcon', image);
    map.addLayer({
      id:'station-icons', type:'symbol', source:'stations',
      layout:{
        'icon-image':'stationIcon',
        'icon-size':0.02,
        'icon-allow-overlap':true,
        'text-field':['get','name'],
        'text-size':12,
        'text-offset':[0,1.2],
        'text-anchor':'top',
        'text-font':['Noto Sans Bold']
      },
      paint:{'text-color':'#000','text-halo-color':'#fff','text-halo-width':1}
    });
  });

  // Train polygon
  function metersToLngLatOffset(mX,mY,lat){
    const lngOffset = mX/(111320*Math.cos(lat*Math.PI/180));
    const latOffset = mY/110540;
    return [lngOffset, latOffset];
  }

  function createTrainFeature(lng,lat,angle=0,widthM=200,lengthM=500){ // 10Ã— bigger
    const coordsMeters=[[-lengthM/2,-widthM/2],[lengthM/2,-widthM/2],[lengthM/2,widthM/2],[-lengthM/2,widthM/2],[-lengthM/2,-widthM/2]];
    const coords = coordsMeters.map(([x,y])=>{
      const xr=x*Math.cos(angle)-y*Math.sin(angle);
      const yr=x*Math.sin(angle)+y*Math.cos(angle);
      const [dx,dy]=metersToLngLatOffset(xr,yr,lat);
      return [lng+dx, lat+dy];
    });
    return {type:'Feature', geometry:{type:'Polygon', coordinates:[coords]}};
  }

  map.addSource('train',{type:'geojson', data:createTrainFeature(stations[0].coord[0],stations[0].coord[1],0)});
  map.addLayer({id:'train-layer', type:'fill-extrusion', source:'train', paint:{'fill-extrusion-color':'#0000ff','fill-extrusion-height':8,'fill-extrusion-base':0,'fill-extrusion-opacity':0.9}});

  let currentAudio = null;

function playAudio(slug) {
  if (isMuted || !slug) return;

  // Stop any currently playing audio
  if (currentAudio) {
    currentAudio.pause();
    currentAudio.currentTime = 0;
  }

  // Start new audio
  currentAudio = new Audio(AUDIO_BASE + slug + '.mp3');
  currentAudio.play().catch(() => {});
}

  // Animate train
  let index=0; const speed=0.0025;
  function animateTrain(){
    const start=stations[index].coord;
    const end=stations[(index+1)%stations.length].coord;
    let t=0;
    function step(){
      t+=speed;
      if(t>=1){
        index=(index+1)%stations.length;
        const [lng,lat]=stations[index].coord;
        const angle=Math.atan2(stations[(index+1)%stations.length].coord[1]-lat,stations[(index+1)%stations.length].coord[0]-lng);
        map.getSource('train').setData(createTrainFeature(lng,lat,angle));
        playAudio(stations[index].slug); showNowPlaying(stations[index].name,3000);
        setTimeout(()=>animateTrain(),16); return;
      }
      const lng=start[0]+(end[0]-start[0])*t;
      const lat=start[1]+(end[1]-start[1])*t;
      const angle=Math.atan2(end[1]-start[1],end[0]-start[0]);
      map.getSource('train').setData(createTrainFeature(lng,lat,angle));
      requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  let journeyStarted=false;
  document.getElementById('startButton').addEventListener('click',()=>{
    if(!journeyStarted){
      journeyStarted=true;
      document.getElementById('splash').style.display='none';
      playAudio(stations[0].slug); showNowPlaying(stations[0].name,3000);
      setTimeout(()=>animateTrain(),850);
    }
  });

  document.getElementById('muteButton').addEventListener('click',()=>{
    isMuted=!isMuted;
    document.getElementById('muteButton').textContent=isMuted?'ðŸ”ˆ Unmute':'ðŸ”Š Mute';
  });

});
</script>
</body>
</html>

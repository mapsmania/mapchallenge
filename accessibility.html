<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Walking Accessibility Map - Valhalla Isochrones</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
  <style>
    body { margin:0; padding:0; font-family:system-ui,sans-serif; background:#fafafa; }
    #map { width:100%; height:90vh; border-radius:12px; }
    #legend {
      position:absolute; bottom:20px; left:20px;
      background:rgba(255,255,255,0.9);
      padding:10px 15px; border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
      font-size:14px; line-height:1.6;
    }
    .legend-item { display:flex; align-items:center; margin-bottom:4px; }
    .legend-color { width:20px; height:20px; margin-right:8px; border-radius:4px; border:1px solid #aaa; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="legend">
    <strong>Walking Time</strong><br>
    <div class="legend-item"><div class="legend-color" style="background:#006400"></div>5 min</div>
    <div class="legend-item"><div class="legend-color" style="background:#228B22"></div>10 min</div>
    <div class="legend-item"><div class="legend-color" style="background:#32CD32"></div>15 min</div>
    <div class="legend-item"><div class="legend-color" style="background:#B22222"></div>20 min</div>
    <div class="legend-item"><div class="legend-color" style="background:#8B0000"></div>25 min</div>
  </div>

  <script>
    const map = new maplibregl.Map({
      style: 'https://tiles.openfreemap.org/styles/liberty',
      center: [-122.4194, 37.7749],
      zoom: 13,
      container: 'map'
    });

    const valhallaUrl = "https://valhalla1.openstreetmap.de/isochrone";

    async function fetchIsochrones(lng, lat) {
      const body = {
        locations: [{ lat: lat, lon: lng }],
        costing: "pedestrian",
        contours: [
          { time: 5 },
          { time: 10 },
          { time: 15 },
          { time: 20 },
          { time: 25 }
        ],
        polygons: true
      };

      const response = await fetch(valhallaUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (!response.ok) {
        console.error("Valhalla error:", response.statusText);
        return;
      }

      const data = await response.json();
      addIsochronesToMap(data);
    }

    function addIsochronesToMap(geojson) {
      const colors = {
        5: "#006400",
        10: "#228B22",
        15: "#32CD32",
        20: "#B22222",
        25: "#8B0000"
      };

      // Sort largest (25 min) to smallest (5 min)
      geojson.features.sort((a,b)=>b.properties.contour - a.properties.contour);

      geojson.features.forEach(f=>{
        f.properties.color = colors[f.properties.contour] || "#ccc";
      });

      if (map.getSource('isochrones')) {
        map.getSource('isochrones').setData(geojson);
      } else {
        map.addSource('isochrones', { type: 'geojson', data: geojson });
        map.addLayer({
          id: 'isochrone-fill',
          type: 'fill',
          source: 'isochrones',
          paint: {
            'fill-color': ['get', 'color'],
            'fill-opacity': 0.45
          }
        });
        map.addLayer({
          id: 'isochrone-outline',
          type: 'line',
          source: 'isochrones',
          paint: { 'line-color': '#333', 'line-width': 1 }
        });
      }
    }

    map.on('load', () => {
      fetchIsochrones(-122.4194, 37.7749);
    });

    map.on('click', e => {
      fetchIsochrones(e.lngLat.lng, e.lngLat.lat);
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>San Francisco Public Transport Reach Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; background: #fafafa; }
    #map { width: 100%; height: 90vh; border-radius: 12px; }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 1;
    }
    label { font-size: 14px; font-weight: bold; margin-right: 8px; }
  </style>
</head>
<body>
  <div id="controls">
    <label>Travel time (minutes):</label>
    <input type="range" id="timeSlider" min="10" max="60" step="10" value="30" />
    <span id="timeLabel">30</span>
  </div>

  <div id="map"></div>

  <script>
    const map = new maplibregl.Map({
      style: 'https://tiles.openfreemap.org/styles/liberty',
      center: [-122.4194, 37.7749], // San Francisco
      zoom: 12,
      container: 'map',
    });

    const ors_api = "https://api.openrouteservice.org/v2/isochrones/foot-walking";
    const api_key = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjhhNTdlOWRlOGJhNTQwNzc5MWM3YTUzZmJhZGNlY2EwIiwiaCI6Im11cm11cjY0In0="; // <-- Replace with your ORS key

    async function fetchIsochrone(lng, lat, minutes) {
      const seconds = minutes * 60;
      const response = await fetch(ors_api, {
        method: "POST",
        headers: {
          "Authorization": api_key,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          locations: [[lng, lat]],
          range: [seconds],
          range_type: "time",
          attributes: ["area"]
        })
      });
      const data = await response.json();
      addIsochronesToMap(data);
    }

    function addIsochronesToMap(geojson) {
      if (map.getSource('isochrones')) {
        map.getSource('isochrones').setData(geojson);
      } else {
        map.addSource('isochrones', { type: 'geojson', data: geojson });
        map.addLayer({
          id: 'isochrone-fill',
          type: 'fill',
          source: 'isochrones',
          paint: {
            'fill-color': '#3B82F6',
            'fill-opacity': 0.35
          }
        });
        map.addLayer({
          id: 'isochrone-outline',
          type: 'line',
          source: 'isochrones',
          paint: {
            'line-color': '#1E3A8A',
            'line-width': 2
          }
        });
      }
    }

    map.on('load', () => {
      fetchIsochrone(-122.4194, 37.7749, 30); // default center
    });

    // Click to move origin
    map.on('click', (e) => {
      const { lng, lat } = e.lngLat;
      fetchIsochrone(lng, lat, parseInt(document.getElementById('timeSlider').value));
    });

    // Slider for travel time
    document.getElementById('timeSlider').addEventListener('input', (e) => {
      const minutes = parseInt(e.target.value);
      document.getElementById('timeLabel').textContent = minutes;
      const center = map.getCenter();
      fetchIsochrone(center.lng, center.lat, minutes);
    });
  </script>
</body>
</html>
